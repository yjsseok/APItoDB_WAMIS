 design.md


    1 # 시스템 및 아키텍처 설계 (Design)
    2
    3 ## 1. 시스템 아키텍처
    4
    5 본 시스템은 다음과 같은 3-Tier 아키텍처로 구성됩니다.
    6
    7 - **Presentation Layer (UI):** Windows Forms (`MainFrm.cs`)
    8 - **Business Logic Layer (Service):** `Wamis_DataSyncService.cs`
    9 - **Data Access Layer (DAL):** `Wamis_DataService.cs`
   10 - **External Communication:** `Wamis_ApiClient.cs`
   11
   12   <!-- 다이어그램 예시 URL -->
   13
   14 ### 1.1. Presentation Layer
   15
   16 - **`MainFrm.cs`:** 애플리케이션의 주 진입점으로, 사용자로부터 데이터 수집
      명령(초기 로드, 일일 동기화)을 받습니다.
   17 - **역할:**
   18     - 서비스 클래스들(`Wamis_ApiClient`, `Wamis_DataService`, `Wamis_DataSyncService`)을 초기화하고 의존성을 주입합니다.
   19     - 사용자의 입력(기간 설정, 버튼 클릭)을 처리합니다.
   20     - `Wamis_DataSyncService`를 호출하여 데이터 수집 프로세스를 시작합니다.
   21     - `log4net`과 연동된 로그 액션을 통해 UI에 진행 상황을 실시간으로 표시합니다.
   22
   23 ### 1.2. Business Logic Layer
   24
   25 - **`Wamis_DataSyncService.cs`:** 데이터 동기화의 핵심 비즈니스 로직을 담당합니다.
   26 - **역할:**
   27     - `PerformInitialLoadAsync`: 지정된 기간 동안의 모든 관측소 데이터를 수집하는 초기 데이터 로드 프로세스를 관리합니다.
   28     - `PerformDailySyncAsync`: 매일 최신 데이터를 수집하는 일일 동기화 프로세스를 관리합니다.
   29     - `Wamis_ApiClient`를 사용하여 WAMIS API로부터 데이터를 가져옵니다.
   30     - `Wamis_DataService`를 사용하여 가져온 데이터를 데이터베이스에저장합니다.
   31     - 테스트 모드를 지원하여 개발 및 테스트 효율성을 높입니다.
   1  - **`BackfillMissingDataAsync` (현: 최근 7일 데이터 최신화):** 최근 7일간의 데이터를 WAMIS API로부터 다시 수집하여 데이터베이스를 최신 상태로 업데이트하는 프로세스를 관리합니다.
   2     - **1단계 (기간 설정):** 내부적으로 최근 7일로 데이터 수집 기간을 설정합니다.
   3     - **2단계 (데이터 재수집):** 설정된 기간에 대해 `Wamis_ApiClient`를 호출하여 모든 관련 데이터를 다시 요청합니다.
   4     - **3단계 (저장):** 재수집된 데이터를 `Wamis_DataService`의 `Upsert` 메서드를 통해 데이터베이스에 저장하여 기존 데이터를 갱신하거나 새 데이터를 추가합니다.
   5     - **(참고: 현재 API 오류 시 별도의 재시도 로직은 포함되어 있지 않음)**
   32
   33 ### 1.3. Data Access Layer
   34
   35 - **`Wamis_DataService.cs`:** 데이터베이스와의 모든 상호작용을 캡슐화합니다.
   36 - **역할:**
   37     - `Npgsql` 라이브러리를 사용하여 PostgreSQL 데이터베이스에 연결합니다.
   38     - `EnsureTablesExistAsync`: 애플리케이션 실행 시 필요한 모든 테이블이 존재하는지 확인하고, 없으면 생성합니다.
   39     - 각 데이터 모델에 맞는 `Upsert` (Update + Insert) 메서드를 제공하여
      데이터의 중복 저장을 방지하고 최신 상태를 유지합니다.
   40     - 모든 데이터베이스 작업은 비동기(`async/await`)로 처리하여 UI의
      응답성을 유지합니다.
   41
   42 ### 1.4. External Communication
   43
   44 - **`Wamis_ApiClient.cs`:** WAMIS API와의 통신을 담당합니다.
   45 - **역할:**
   46     - `GetDataAsync<T>`: 제네릭 메서드를 사용하여 다양한 종류의 API 요청을
      처리하고, JSON 응답을 지정된 C# 모델 객체(`T`)로 역직렬화합니다.
   47     - `HttpClient`를 사용하여 비동기적으로 HTTP GET 요청을 보냅니다.
   48     - API 요청 URL 생성 및 파라미터 인코딩을 처리합니다.
   49     - 기본적인 예외 처리 및 로깅을 수행합니다.
   50
   51 ## 2. 데이터 모델
   52
   53 - **`W_Models/WAMIS_Models.cs`:** WAMIS API 응답의 JSON 구조에 맞춰 C#
      클래스를 정의합니다.
   54 - **주요 모델:** `StationInfo`, `RfHourly`, `WlDaily` 등 각 데이터 종류에
      맞는 모델이 정의되어 있습니다.
   55 - 이 모델들은 `Newtonsoft.Json` 라이브러리를 통해 JSON 데이터와 매핑됩니다.
   56
   57 ## 3. 데이터베이스 스키마
   58
   59 - **데이터베이스:** PostgreSQL
   60 - **테이블:**
   61     - `stations`: 관측소 기본 정보
   62     - `rf_hourly`, `rf_daily`, `rf_monthly`: 강수량 데이터 (시간/일/월별)
   63     - `wl_hourly`, `wl_daily`: 수위 데이터 (시간/일별)
   64     - `weather_hourly`, `weather_daily`: 기상 데이터 (시간/일별)
   65     - `flow_measurements`, `flow_daily`: 유량 데이터 (측정/일별)
   66 - **키:** 각 데이터 테이블은 `station_code`와 `obs_time` 또는 `obs_date`를
      복합 기본 키로 사용하여 데이터의 유일성을 보장합니다.
   67
   68 ## 4. 설정 및 로깅
   69
   70 - **`App.config`:** 데이터베이스 연결 문자열, WAMIS API 키 및 URL 등 주요
      설정을 저장합니다.
   71 - **`log4net.config`:** `log4net` 라이브러리를 사용하여 로그 파일 생성
      규칙, 로그 레벨, 출력 형식 등을 설정합니다. 이를 통해 파일 로깅과 UI 로깅을
      동시에 지원합니다.