 development.md


    1 # 개발/구현 가이드 (Development Guide)
    2
    3 ## 1. 개발 환경
    4
    5 - **IDE:** Visual Studio 2022 이상
    6 - **Framework:** .NET Framework 4.8
    7 - **Language:** C#
    8 - **Database:** PostgreSQL
    9 - **Dependencies:**
   10     - `Npgsql`: PostgreSQL 데이터베이스 연동
   11     - `Newtonsoft.Json`: JSON 데이터 처리
   12     - `log4net`: 로깅
   13
   14 ## 2. 프로젝트 구조
   15
   16 - **`WamisDataCollector/`**: 메인 프로젝트 디렉토리
   17     - **`MainFrm.cs`**: 메인 UI 폼
   18     - **`Program.cs`**: 프로그램 시작점
   19     - **`W_Models/`**: 데이터 모델 클래스
   20         - `WAMIS_Models.cs`: WAMIS API 응답 구조에 따른 C# 클래스 정의
   21     - **`W_Services/`**: 서비스 로직 클래스
   22         - `Wamis_ApiClient.cs`: WAMIS API 클라이언트
   23         - `Wamis_DataService.cs`: PostgreSQL 데이터베이스 서비스
   24         - `Wamis_DataSyncService.cs`: 데이터 동기화 서비스
   25     - **`Properties/`**: 프로젝트 속성 및 리소스
   26     - **`config/`**: 설정 파일
   27         - `App.config`: 애플리케이션 설정 (API 키, DB 연결 문자열 등)
   28         - `log4net.config`: log4net 로깅 설정
   29         - `packages.config`: NuGet 패키지 종속성
   30
   31 ## 3. 주요 구현 내용
   32
   33 ### 3.1. API 클라이언트 (`Wamis_ApiClient.cs`)
   34
   35 - `GetDataAsync<T>` 메서드는 제네릭을 사용하여 다양한 API 응답을 처리할 수
      있도록 구현되었습니다.
   36 - `HttpClient`를 사용하여 비동기적으로 API를 호출하며, 이는 UI의 응답성을
      유지하는 데 중요합니다.
   37 - API 요청 시 필요한 파라미터는 `Dictionary<string, string>` 형태로 받아
      `FormUrlEncodedContent`를 통해 쿼리 문자열로 변환합니다.
   38
   39 ### 3.2. 데이터 서비스 (`Wamis_DataService.cs`)
   40
   41 - 모든 데이터베이스 쿼리는 `Npgsql` 라이브러리를 사용하여 실행됩니다.
   42 - `Upsert` 로직 구현:
   43     - PostgreSQL의 `ON CONFLICT ... DO UPDATE` 구문을 사용하여 `INSERT` 시
      기본 키 충돌이 발생하면 `UPDATE`를 수행하도록 구현했습니다.
   44     - 이를 통해 데이터의 중복 삽입을 방지하고, 기존 데이터는 최신 정보로
      업데이트됩니다.
   45 - 모든 DB 작업은 `async/await` 패턴을 사용하여 비동기적으로 처리됩니다.
   46
   47 ### 3.3. 데이터 동기화 서비스 (`Wamis_DataSyncService.cs`)
   48
   49 - **초기 데이터 로드 (`PerformInitialLoadAsync`):**
   50     1. `_dataService.EnsureTablesExistAsync()`를 호출하여 DB 테이블을
      준비합니다.
   51     2. `FetchAndStoreAllStations()`를 호출하여 모든 관측소 정보를 가져와
      DB에 저장합니다.
   52     3. 사용자가 지정한 기간(startDate, endDate)과 처리할 관측소 목록을
      기반으로 각 데이터 유형(강수량, 수위 등)에 대한 API 요청을 병렬로
      실행합니다.
   53     4. 각 API 응답을 받아 `_dataService`의 `Upsert` 메서드를 호출하여 DB에
      저장합니다.
   54 - **일일 동기화 (`PerformDailySyncAsync`):**
   55     - 어제 날짜를 기준으로 `startDate`와 `endDate`를 설정하여
      `PerformInitialLoadAsync`를 호출하는 방식으로 구현되었습니다. 이는 코드
      재사용성을 높입니다.
	  
    1 ### 3.3.1. 누락 데이터 보충 로직 구현
    2
    3 - **신규 메서드 추가:** `Wamis_DataSyncService.cs`에 `public async Task
      BackfillMissingDataAsync(DataType type, DateTime startDate, DateTime
      endDate)`와 같은 형태의 신규 메서드를 구현합니다.
    4 - **누락 기간 식별 쿼리:**
    5     - PostgreSQL의 `generate_series` 함수를 사용하여 `startDate`와
      `endDate` 사이의 모든 시간/날짜 목록을 생성합니다.
    6     - 생성된 시리즈를 실제 데이터 테이블과 `LEFT JOIN`하고, 데이터가
      없는(NULL) 행을 찾아 누락된 시점을 식별하는 SQL 쿼리를 `Wamis_DataService`
      에 구현합니다.
    7 - **재수집 로직:**
    8     - 식별된 누락 시점들을 기반으로 WAMIS API가 요구하는 형식(예: 10일
      단위)에 맞춰 요청 기간을 분할합니다.
    9     - 각 기간에 대해 기존의 `_apiClient.GetDataAsync<T>()`를 호출하여
      데이터를 재수집합니다.
   10 - **UI 연동:**
   11     - `MainFrm.cs`에 "누락 데이터 보충" 버튼을 추가하고, 이 버튼 클릭 시
      `BackfillMissingDataAsync` 메서드가 호출되도록 구현합니다.

	  
   56
   57 ### 3.4. UI (`MainFrm.cs`)
   58
   59 - UI 스레드와 백그라운드 작업 스레드를 분리하기 위해 `async/await`를
      적극적으로 사용합니다.
   60 - `Log` 메서드는 `RichTextBox`에 로그를 추가할 때 `Invoke`를 사용하여 UI
      컨트롤이 다른 스레드에서 접근될 때 발생하는 문제를 방지합니다.
   61 - `App.config`에서 설정을 불러와 각 서비스 클래스에 필요한 정보를
      전달(의존성 주입)하는 역할을 합니다.
   62
   63 ## 4. 빌드 및 실행
   64
   65 1. Visual Studio에서 `APItoDB.sln` 파일을 엽니다.
   66 2. `config/App.config` 파일에 WAMIS API 키와 PostgreSQL 연결 문자열을
      올바르게 입력합니다.
   67 3. 프로젝트를 빌드합니다 (Ctrl+Shift+B).
   68 4. `bin/Debug` 또는 `bin/Release` 폴더에 생성된 `APItoDB_WAMIS.exe` 파일을
      실행합니다.
   69
   70 ## 5. 코드 컨벤션
   71
   72 - **네이밍:** Microsoft의 C# 코딩 규칙을 따릅니다. (클래스명은 PascalCase,
      메서드명은 PascalCase, 지역 변수는 camelCase 등)
   73 - **주석:** 복잡한 로직이나 중요한 결정 사항에 대해서는 간결하고 명확한
      주석을 작성합니다.
   74 - **에러 처리:** `try-catch` 블록을 사용하여 예외를 처리하고, `log4net`을
      통해 에러 내용을 기록합니다.